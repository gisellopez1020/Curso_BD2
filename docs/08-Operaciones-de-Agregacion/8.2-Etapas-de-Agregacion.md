# Etapas de AgregaciÃ³n

Las etapas de una agregaciÃ³n son un conjunto de operaciones fundamentales del framework de agregaciÃ³n de MongoDB (Conjunto de herramientas que facilitan el procesamiento y anÃ¡lisis de forma directa en la base de datos [[9]](../11-Referencias/11-Referencias-Modulo-2.md#9)â€‹, [[11]](../11-Referencias/11-Referencias-Modulo-2.md#11)â€‹).  

En una agregaciÃ³n, cada etapa recibe documentos de entrada para realizar una operaciÃ³n sobre ellos y producir documentos de salida para cada etapa del pipeline. Algunas de los operadores mÃ¡s comunes usados en las etapas de una agregaciÃ³n son: 

- `ğŸ”$match:` Permite agrupar documentos por un campo especÃ­fico. AdemÃ¡s, permite realizar operaciones de agregaciÃ³n como conteos, sumas o promedios, entre otras.

- `ğŸ“$project:` Permite incluir o excluir campos de los documentos. AdemÃ¡s, ofrece la oportunidad de crear nuevos cuando es necesario crear campos calculados. 

- `â†•ï¸$sort:` Ordenar los documentos de acuerdo con uno o varios campos. 

- `ğŸ”¢$limit:` Se utiliza para limitar el nÃºmero de documentos que pasan a travÃ©s de un pipeline. 

- ğŸ”—`$lookup:` Se utiliza para llevar a cabo la uniÃ³n entre colecciones mediante atributos comunes. Similar al JOIN en SQL. 

- `ğŸŒ€$unwind:` Permite descomponer los campos de tipo array pertenecientes a los documentos de una colecciÃ³n o los generados mediante la aplicaciÃ³n del operador *$lookup* en mÃºltiples documentos individuales.

 _**Nota:** Las etapas de un pipeline de una agregaciÃ³n nos son consideradas como
          operadores. Pero estas etapas si hacen uso de operadores para realizar las
          operaciones especÃ­ficas sobre los datos de los documentos asociados en una
          agregaciÃ³n._
  
![Modulo2 Ejemplo2](../../imgs/modulo2Ejemplo2.png)

**Figura 17: Esquema de Documentos Base de Datos Modulo2Ejemplo2**

## _**MongoDB Script**_

```
use Modulo2Ejemplo2 

db.createCollection("empresas", { 

    "capped": false, 

    "validator": { 

        "$jsonSchema": { 

            "bsonType": "object", 

            "title": "empresas", 

            "properties": { 

                "_id": { 

                    "bsonType": "objectId" 

                }, 

                "nombre": { 

                    "bsonType": "string" 

                }, 

                "fechaFundacion": { 

                    "bsonType": "date" 

                }, 

                "area": { 

                    "bsonType": "string" 

                }, 

                "sedes": { 

                    "bsonType": "array", 

                    "additionalItems": true, 

                    "items": { 

                        "bsonType": "object", 

                        "properties": { 

                            "_id": { 

                                "bsonType": "objectId" 

                            }, 

                            "telefono": { 

                                "bsonType": "string" 

                            }, 

                            "ciudad": { 

                                "bsonType": "string" 

                            }, 

                            "tipo": { 

                                "bsonType": "string", 

                                "enum": [ 

                                    "sede central", 

                                    "sucursal" 

                                ] 

                            } 

                        }, 

                        "additionalProperties": false, 

                        "required": [ 

                            "_id", 

                            "telefono", 

                            "ciudad", 

                            "tipo" 

                        ] 

                    } 

                } 

            }, 

            "additionalProperties": true, 

            "required": [ 

                "_id", 

                "nombre", 

                "fechaFundacion", 

                "area" 

            ] 

        } 

    }, 

    "validationLevel": "moderate", 

    "validationAction": "error" 

}); 

db.createCollection("empleados", { 

    "capped": false, 

    "validator": { 

        "$jsonSchema": { 

            "bsonType": "object", 

            "title": "empleados", 

            "properties": { 

                "_id": { 

                    "bsonType": "objectId" 

                }, 

                "nombre": { 

                    "bsonType": "string" 

                }, 

                "sexo": { 

                    "bsonType": "string", 

                    "enum": [ 

                        "M", 

                        "H" 

                    ] 

                }, 

                "edad": { 

                    "bsonType": "int" 

                }, 

                "vinculaciones": { 

                    "bsonType": "array", 

                    "additionalItems": true, 

                    "items": { 

                        "bsonType": "object", 

                        "properties": { 

                            "sedeId": { 

                                "bsonType": "objectId" 

                            }, 

                            "puesto": { 

                                "bsonType": "string" 

                            }, 

                            "salario": { 

                                "bsonType": "int" 

                            }, 

                            "estado": { 

                                "bsonType": "string", 

                                "enum": [ 

                                    "activo", 

                                    "inactivo" 

                                ] 

                            }, 

                            "fecha_vinculacion": { 

                                "bsonType": "date" 

                            } 

                        }, 

                        "additionalProperties": false, 

                        "required": [ 

                            "sedeId", 

                            "puesto", 

                            "salario", 

                            "estado", 

                            "fecha_vinculacion" 

                        ] 

                    } 

                } 

            }, 

            "additionalProperties": true, 

            "required": [ 

                "_id", 

                "nombre", 

                "sexo", 

                "edad", 

                "vinculaciones" 

            ] 

        } 

    }, 

    "validationLevel": "moderate", 

    "validationAction": "error" 

}); 
```

## _**Documentos base**_


```
const sedeCentralId = ObjectId(); 

const sedeBogotaId = ObjectId(); 

const sedeMedellinId = ObjectId(); 

const sedeBarranquillaId = ObjectId(); 

db.empresas.insertOne({  

  "nombre": "DevSoft S.A", 

  "fechaFundacion": new Date("2023-01-10"), 

  "area":"Servicios y Desarrollo de software", 

  "sedes":[ 

           {"_id":sedeCentralId,"telefono": "123-456-789", "ciudad": "Cali", "tipo":"sede central"}, 

           {"_id":sedeBogotaId,"telefono": "987-654-321", "ciudad": "BogotÃ¡", "tipo":"sucursal"}, 

           {"_id":sedeMedellinId,"telefono": "555-444-333", "ciudad": "MedellÃ­n","tipo":"sucursal" }, 

           {"_id":sedeBarranquillaId,"telefono": "435-123-222", "ciudad": "Barranquilla", "tipo":"sucursal"} 

  ] 

}); 

db.empleados.insertMany([ 

  { 

    "nombre": "Juan PÃ©rez", 

    "sexo": "H", 

    "edad": 30, 

    "vinculaciones": [ 

      { 

        "sedeId": sedeCentralId, 

        "puesto": "Desarrollador", 

        "salario": 3000, 

        "estado": "activo", 

        "fecha_vinculacion": new Date("2023-01-10") 

      } 

    ] 

  }, 

  { 

    "nombre": "Ana GÃ³mez", 

    "sexo": "M", 

    "edad": 28, 

    "vinculaciones": [ 

      { 

        "sedeId": sedeCentralId, 

        "puesto": "Analista", 

        "salario": 2500, 

        "estado": "activo", 

        "fecha_vinculacion": new Date("2023-01-10") 

      } 

    ] 

  }, 

  { 

    "nombre": "Carlos DÃ­az", 

    "sexo": "H", 

    "edad": 35, 

    "vinculaciones": [ 

      { 

        "sedeId": sedeBogotaId, 

        "puesto": "Desarrollador", 

        "salario": 3500, 

        "estado": "activo", 

        "fecha_vinculacion": new Date("2023-02-01") 

      } 

    ] 

  }, 

  { 

    "nombre": "Luisa MartÃ­nez", 

    "sexo": "M", 

    "edad": 40, 

    "vinculaciones": [ 

      { 

        "sedeId": sedeBogotaId, 

        "puesto": "Gerente", 

        "salario": 5000, 

        "estado": "activo", 

        "fecha_vinculacion": new Date("2023-02-15") 

      } 

    ] 

  }, 

  { 

    "nombre": "Pedro GarcÃ­a", 

    "sexo": "H", 

    "edad": 25, 

    "vinculaciones": [ 

      { 

        "sedeId": sedeMedellinId, 

        "puesto": "Desarrollador", 

        "salario": 2800, 

        "estado": "activo", 

        "fecha_vinculacion": new Date("2023-03-01") 

      } 

    ] 

  }, 

  { 

    "nombre": "MarÃ­a LÃ³pez", 

    "sexo": "M", 

    "edad": 32, 

    "vinculaciones": [ 

      { 

        "sedeId": sedeMedellinId, 

        "puesto": "Analista", 

        "salario": 3000, 

        "estado": "activo", 

        "fecha_vinculacion": new Date("2023-03-05") 

      } 

    ] 

  }, 

  { 

    "nombre": "Ricardo Ortega", 

    "sexo": "H", 

    "edad": 27, 

    "vinculaciones": [ 

      { 

        "sedeId": sedeBarranquillaId, 

        "puesto": "Soporte TÃ©cnico", 

        "salario": 2600, 

        "estado": "activo", 

        "fecha_vinculacion": new Date("2023-04-01") 

      } 

    ] 

  }, 

  { 

    "nombre": "Laura MÃ©ndez", 

    "sexo": "M", 

    "edad": 29, 

    "vinculaciones": [ 

      { 

        "sedeId": sedeBarranquillaId, 

        "puesto": "DiseÃ±adora", 

        "salario": 2700, 

        "estado": "activo", 

        "fecha_vinculacion": new Date("2023-04-10") 

      } 

    ] 

  } 

]); 
```

> ### ğŸ‘‰ **ContinÃºa al tema de [Agregaciones simples â•](8.3-Agregaciones-Simples/8.3-Agregaciones-Simples.md)**
